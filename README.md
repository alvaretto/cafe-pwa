# Tinto del Mirador CRM

CRM integral especializado para emprendimientos de venta de café por libras, medias libras y gramos. Una aplicación web progresiva (PWA) moderna **completamente funcional** con capacidades offline y funcionalidades inteligentes impulsadas por **Anthropic Claude AI**.

## 🚀 Estado Actual - Aplicación 100% Operativa y Estable

**✅ TODOS LOS MÓDULOS ESTÁN FUNCIONANDO CORRECTAMENTE**

La aplicación CRM Tinto del Mirador está completamente implementada, estable y operativa con todos sus módulos principales funcionando sin errores. El sistema incluye **integración completa con Anthropic Claude AI** para asistencia inteligente, análisis contable PUC 2025 y consultas contextuales. Incluye datos mock para demostración y está lista para conectarse a servicios de producción.

## ✅ Módulos Completamente Operativos

### 🏠 **Dashboard Principal**
- ✅ Panel de control inteligente con métricas KPI en tiempo real
- ✅ Gráficos interactivos de ventas y tendencias
- ✅ Centro de notificaciones (3 notificaciones activas)
- ✅ Alertas de inventario críticas (3 alertas activas)
- ✅ Insights de IA con recomendaciones personalizadas
- ✅ Acciones rápidas para todas las funcionalidades
- ✅ Navegación completa entre todos los módulos

### 🛍️ **Sistema de Ventas POS**
- ✅ Punto de venta completamente funcional
- ✅ Catálogo de 8 productos con precios múltiples
- ✅ Carrito de compras interactivo
- ✅ Soporte para múltiples unidades (gramos, media libra, libra)
- ✅ Selección de clientes integrada
- ✅ Estadísticas de ventas (hoy, semana, mes, histórico)
- ✅ Cálculos automáticos de precios

### 👥 **Gestión de Clientes**
- ✅ Interfaz completa de CRM
- ✅ Sistema de búsqueda y filtros avanzados
- ✅ Segmentación automática de clientes
- ✅ Funcionalidad "Nuevo Cliente" operativa
- ✅ Sistema de ordenamiento múltiple
- ✅ Preparado para historial de compras y fidelización

### ☕ **Gestión de Productos**
- ✅ Catálogo completo de productos de café
- ✅ Filtros por categoría y búsqueda
- ✅ Precios múltiples por unidad de medida
- ✅ Funcionalidad "Nuevo Producto" operativa
- ✅ Control de costos y márgenes
- ✅ Sistema de categorización

### 📦 **Control de Inventario**
- ✅ Monitoreo inteligente de stock en tiempo real
- ✅ Sistema de alertas automáticas (1 crítica, 1 alta)
- ✅ Tabs organizados: Resumen, Alertas, Movimientos, Reabastecimiento, Proveedores
- ✅ Predicción de demanda
- ✅ Gestión completa de proveedores
- ✅ Historial de movimientos

### 🛒 **Módulo de Compras**
- ✅ Sistema completo de gestión de compras
- ✅ Registro de nuevas compras a proveedores
- ✅ Historial completo de transacciones
- ✅ Gestión de proveedores integrada
- ✅ Control de costos de inventario
- ✅ Actualización automática de stock

### 💰 **Control de Gastos**
- ✅ Gestión financiera empresarial completa
- ✅ Categorización automática de gastos
- ✅ Sistema de presupuestos y control de costos
- ✅ Tabs organizados: Resumen, Presupuestos, Gastos, Reportes, Categorías
- ✅ Análisis de rentabilidad
- ✅ Funcionalidad "Nuevo Gasto" operativa

### 📊 **Sistema de Reportes**
- ✅ Inteligencia de negocio avanzada
- ✅ 5 reportes activos, 4 programados
- ✅ Tabs: Resumen, Plantillas, Generar, Historial, Analytics
- ✅ Dashboards personalizables
- ✅ Análisis de tendencias
- ✅ Exportación en múltiples formatos

### ⚙️ **Configuración del Sistema**
- ✅ Panel completo de configuración
- ✅ Tabs: Resumen, Sistema, Usuario, Empresa, Notificaciones, Seguridad
- ✅ **Pestaña "Usuario" > Sección "Apariencia" > Control "Tema" completamente optimizado**
  - ✅ **Selector de tema "Oscuro" funcionando sin comportamiento errático**
  - ✅ Manejo robusto de hidratación cliente-servidor
  - ✅ Sincronización mejorada entre next-themes y preferencias de usuario
  - ✅ Debounce implementado para prevenir cambios múltiples simultáneos
  - ✅ Estados de carga visual con indicadores de progreso
  - ✅ Manejo de errores con reversión automática en caso de fallo
  - ✅ Transiciones CSS suaves para cambios de tema
  - ✅ Prevención de flash de contenido no estilizado (FOUC)
  - ✅ Configuración de idioma, moneda y zona horaria con validación
  - ✅ Formato de fecha personalizable
  - ✅ Todas las preferencias se mantienen después de refrescar la página
- ✅ Gestión de roles y permisos
- ✅ Configuración empresarial

### 🤖 **Chat con Inteligencia Artificial**
- ✅ **Asistente inteligente** impulsado por Anthropic Claude AI
- ✅ **Control de roles**: Acceso diferenciado para ADMIN y VENDEDOR
- ✅ **Consultas contextuales** basadas en datos reales del CRM
- ✅ **Análisis contable PUC 2025** para clasificación de transacciones
- ✅ **Respuestas en tiempo real** con formato markdown
- ✅ **Historial de conversación** y preguntas sugeridas
- ✅ **Validaciones de seguridad** por rol de usuario
- ✅ **Sistema de fallback** robusto con respuestas de demostración

## 🛠️ Tecnologías Utilizadas

### Frontend
- **Next.js 14.2.32** - Framework React con App Router
- **TypeScript** - Tipado estático para mayor robustez
- **Tailwind CSS** - Framework de estilos utilitarios
- **Radix UI** - Componentes de interfaz accesibles
- **Lucide React** - Iconografía moderna y consistente
- **Framer Motion** - Animaciones fluidas
- **React Hook Form** - Manejo eficiente de formularios
- **Zustand** - Gestión de estado global

### Inteligencia Artificial
- **Anthropic Claude AI** - Asistente inteligente principal (claude-3-haiku-20240307)
- **Google Gemini AI** - Sistema de respaldo (gemini-pro)
- **React Markdown** - Renderizado de respuestas con formato

## 📊 Mejoras Contables Implementadas - PUC 2025

**✅ CUMPLIMIENTO COMPLETO CON PLAN ÚNICO DE CONTABILIDAD (PUC) 2025 DE COLOMBIA**

El CRM Tinto del Mirador ahora incluye un sistema contable robusto que cumple con los principios contables modernos del Plan Único de Contabilidad (PUC) 2025 de Colombia, facilitando la integración con sistemas contables profesionales.

### 🔧 **Correcciones Contables Críticas Implementadas**

**✅ TRATAMIENTO CORRECTO DE MATERIAS PRIMAS SEGÚN PUC 2025**

Se han implementado correcciones fundamentales para asegurar el tratamiento contable correcto de materias primas y otros conceptos según las normas del PUC 2025:

#### 🎯 **Problema Identificado y Corregido**
- **❌ Error Anterior**: Materias primas clasificadas incorrectamente como "gastos"
- **✅ Corrección Aplicada**: Materias primas ahora se clasifican correctamente como "activos" (Cuenta 1405)
- **📋 Flujo Correcto**: Compra → Inventario de Materias Primas → Costo de Ventas (cuando se consume)

#### 📦 **Tratamiento Específico de Materiales de Empaque**
- **✅ Clasificación Correcta**: Bolsas de café, etiquetas, cajas → Inventario de Materias Primas (1405)
- **✅ Justificación PUC 2025**: Son insumos necesarios para completar el producto final
- **✅ Flujo Contable**: Compra → 1405 → 1410 (Productos en Proceso) → 1430 (Productos Terminados) → 6135 (Costo de Ventas)
- **✅ Ejemplos Implementados**: Bolsas kraft 1 libra, bolsas 500g, etiquetas adhesivas, cajas de cartón

#### 🔍 **Sistema de Validación Automática**
- **Clasificador Inteligente**: Detecta automáticamente si una transacción debe ser activo o gasto
- **Reconocimiento de Materiales de Empaque**: Identifica bolsas, etiquetas, cajas, envases automáticamente
- **Alertas de Advertencia**: Notifica cuando se detectan clasificaciones incorrectas
- **Validación en Tiempo Real**: Previene errores contables antes de registrar transacciones
- **Palabras Clave Reconocidas**: "bolsa", "etiqueta", "caja", "empaque", "1 libra", "250g", "500g", "kraft", "válvula"

### 🧮 **Módulo de Inventarios - Contabilidad**
- ✅ **Valoración PEPS (Primeras Entradas, Primeras Salidas)** - Método oficial según PUC 2025
- ✅ **Cuentas de inventario completas** - Grupo 14 según PUC 2025:
  - **1405** - Inventario de Materias Primas (café verde, insumos)
  - **1410** - Inventario de Productos en Proceso (café en tostado)
  - **1430** - Inventario de Productos Terminados (café listo para venta)
  - **1435** - Inventario de Mercancías (productos para reventa)
- ✅ **Gestión de Materias Primas** - Control completo de café verde y suministros
- ✅ **Provisiones por deterioro** - Control automático de obsolescencia y mermas
- ✅ **Registro de diferencias** - Ajustes positivos y negativos con asientos automáticos
- ✅ **Movimientos contables** - Trazabilidad completa de entradas y salidas
- ✅ **Capas de inventario** - Sistema PEPS con control de costos por lote
- ✅ **Reportes contables** - Balance de inventarios y auxiliares detallados

### 💰 **Módulo de Compras - Contabilidad**
- ✅ **Clasificación Automática Inteligente** - Distingue entre materias primas y mercancías
- ✅ **Asientos Diferenciados**:
  - **Materias Primas**: Débito a cuenta 1405 (Inventario de Materias Primas)
  - **Mercancías**: Débito a cuenta 1435 (Inventario de Mercancías)
- ✅ **Cuentas por pagar** - Grupo 22 (2205 - Proveedores Nacionales)
- ✅ **IVA descontable** - Cuenta 1355 con control automático
- ✅ **Retenciones en la fuente** - Cuenta 2365 con cálculos automáticos
- ✅ **Asientos contables automáticos** - Generación según normativa PUC 2025
- ✅ **Control de vencimientos** - Seguimiento de pagos y plazos
- ✅ **Documentación soporte** - Vinculación de facturas y remisiones
- ✅ **Reportes de compras** - Auxiliar de proveedores y control de IVA

### 💸 **Módulo de Gastos - Clasificación PUC 2025**
- ✅ **Validación Contable Avanzada** - Detecta materias primas mal clasificadas como gastos
- ✅ **Alertas de Corrección** - Notifica cuando una transacción debe ser activo, no gasto
- ✅ **Gastos de administración** - Grupo 51 (5105, 5110, 5120, 5135, 5145)
- ✅ **Gastos de ventas** - Grupo 52 (5205, 5210, 5220, 5225)
- ✅ **Gastos financieros** - Grupo 53 (5305, 5315)
- ✅ **Otros gastos** - Grupo 54 (5495)
- ✅ **Clasificación automática** - IA que asigna cuentas PUC según descripción
- ✅ **Control de deducibilidad** - Identificación automática de gastos deducibles
- ✅ **Separación operacional** - Distinción entre gastos operacionales y no operacionales

### 📋 **Funcionalidades Contables Avanzadas**
- ✅ **Clasificador de Transacciones** - Determina automáticamente si es activo o gasto
- ✅ **Generador de asientos diferenciados**:
  - **Materias Primas**: Asientos específicos para cuenta 1405
  - **Consumo de MP**: Transferencia a productos en proceso (1410)
  - **Mercancías**: Asientos para cuenta 1435
- ✅ **Sistema de Alertas Contables** - Previene clasificaciones incorrectas
- ✅ **Balance de comprobación** - Verificación automática de débitos = créditos
- ✅ **Auxiliares por cuenta** - Movimientos detallados por código PUC
- ✅ **Estado de resultados** - Clasificación automática de ingresos y gastos
- ✅ **Control de integridad** - Validación de consistencia contable
- ✅ **Reportes fiscales** - Preparación para declaraciones tributarias
- ✅ **Trazabilidad completa** - Auditoría de todas las transacciones contables

### 🔧 **Arquitectura Contable**
- ✅ **Tipos TypeScript** - Definiciones completas para entidades contables
- ✅ **Utilidades PUC** - Funciones especializadas para cálculos contables
- ✅ **Validaciones automáticas** - Verificación de reglas contables
- ✅ **Datos mock** - Ejemplos completos para demostración
- ✅ **Interfaz intuitiva** - Pestañas especializadas en cada módulo
- ✅ **Documentación técnica** - Explicación detallada de implementación

### Backend & Database
- **Next.js API Routes** - Endpoints del servidor
- **Prisma ORM** - Mapeo objeto-relacional
- **PostgreSQL** - Base de datos principal
- **NextAuth.js** - Sistema de autenticación
- **Firebase** - Servicios en la nube y autenticación
- **Resend** - Servicio de emails transaccionales

### AI & Analytics
- **Google Gemini** - Inteligencia artificial para insights
- **TanStack Query** - Gestión optimizada de datos del servidor
- **Recharts** - Gráficos y visualizaciones interactivas

### DevOps & Tools
- **ESLint & Prettier** - Linting y formateo de código
- **Jest & Testing Library** - Testing unitario
- **Playwright** - Testing end-to-end
- **PWA** - Aplicación web progresiva

## 📋 Requisitos del Sistema

### Requisitos Mínimos
- **Node.js** >= 18.0.0
- **npm** >= 8.0.0
- **PostgreSQL** >= 13.0 (opcional para desarrollo)
- **Memoria RAM** >= 4GB
- **Espacio en disco** >= 2GB

### Navegadores Soportados
- Chrome >= 90
- Firefox >= 88
- Safari >= 14
- Edge >= 90

## 🚀 Instalación y Ejecución

### 1. Clonar el repositorio
```bash
git clone https://github.com/alvaretto/cafe-pwa.git
cd cafe-pwa
```

### 2. Instalar dependencias
```bash
npm install
```

### 3. Configurar variables de entorno
Copia el archivo `.env.local` existente o crea uno nuevo:

```env
# Base de datos (opcional para desarrollo)
DATABASE_URL="postgresql://username:password@localhost:5432/tinto_del_mirador"

# NextAuth.js
NEXTAUTH_URL="http://localhost:3001"
NEXTAUTH_SECRET="tu-secret-super-seguro-aqui"

# Firebase (opcional)
NEXT_PUBLIC_FIREBASE_API_KEY="tu-firebase-api-key"
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="tu-proyecto.firebaseapp.com"
NEXT_PUBLIC_FIREBASE_PROJECT_ID="tu-proyecto-id"

# Inteligencia Artificial
ANTHROPIC_API_KEY="tu-anthropic-api-key"  # Principal - Obtener en https://console.anthropic.com/
GEMINI_API_KEY="tu-gemini-api-key"        # Respaldo - Obtener en https://makersuite.google.com/

# App Configuration
NEXT_PUBLIC_APP_URL="http://localhost:3001"
NEXT_PUBLIC_APP_NAME="Tinto del Mirador CRM"
```

### 4. Configurar Chat con IA (Opcional)

Para habilitar el asistente inteligente con respuestas reales:

1. **Obtener API Key de Anthropic Claude (Recomendado):**
   - Visita https://console.anthropic.com/
   - Crea una cuenta y genera una API key
   - Agrega la clave en `ANTHROPIC_API_KEY` en tu archivo `.env.local`

2. **Obtener API Key de Google Gemini (Respaldo):**
   - Visita https://makersuite.google.com/app/apikey
   - Genera una API key
   - Agrega la clave en `GEMINI_API_KEY` en tu archivo `.env.local`

**Nota:** El sistema funciona sin API keys usando respuestas de demostración inteligentes.

### 5. Ejecutar en modo desarrollo
```bash
# Ejecutar en puerto fijo 3001 (configurado permanentemente)
npm run dev
```

La aplicación estará disponible en:
- **Puerto 3001**: `http://localhost:3001` (puerto fijo y permanente)

### 🔑 Credenciales de Acceso

La aplicación incluye un sistema de autenticación completo. Al acceder a cualquier ruta protegida, se mostrará automáticamente un modal de login con las siguientes credenciales de demo:

**👤 Usuario Administrador:**
- **Email**: `admin@tintodel-mirador.com`
- **Contraseña**: `admin123`
- **Permisos**: Acceso completo a todos los módulos

**👤 Usuario Vendedor:**
- **Email**: `vendedor@tintodel-mirador.com`
- **Contraseña**: `vendedor123`
- **Permisos**: Acceso a ventas, clientes, productos, inventario y reportes

> **Nota**: El modal de login incluye botones para llenar automáticamente estas credenciales.

#### 🌐 URLs de Acceso a los Módulos
Una vez autenticado, puedes acceder a todos los módulos:

- **🏠 Página Principal**: `http://localhost:3001` (página de login)
- **📊 Dashboard**: `http://localhost:3001/dashboard` 🔒
- **🛍️ Ventas**: `http://localhost:3001/ventas` 🔒
- **👥 Clientes**: `http://localhost:3001/clientes` 🔒
- **☕ Productos**: `http://localhost:3001/productos` 🔒
- **📦 Inventario**: `http://localhost:3001/inventario` 🔒
- **🛒 Compras**: `http://localhost:3001/compras` 🔒
- **💰 Gastos**: `http://localhost:3001/gastos` 🔒👑 (solo administradores)
- **📊 Reportes**: `http://localhost:3001/reportes` 🔒
- **⚙️ Configuración**: `http://localhost:3001/configuracion` 🔒👑 (solo administradores)

> **🔒 Rutas Protegidas**: Todas las rutas marcadas requieren autenticación
> **👑 Solo Administradores**: Gastos y Configuración requieren permisos de administrador

### 5. Construir para producción
```bash
npm run build
npm start
```

## 📁 Estructura de Módulos

```
src/app/
├── dashboard/          # 🏠 Panel principal con métricas y KPIs
├── ventas/            # 🛍️ Sistema POS y gestión de ventas
├── clientes/          # 👥 CRM y gestión de clientes
├── productos/         # ☕ Catálogo y gestión de productos
├── inventario/        # 📦 Control de stock y alertas
├── compras/           # 🛒 Gestión de compras a proveedores
├── gastos/            # 💰 Control financiero y presupuestos
├── reportes/          # 📊 Reportes e inteligencia de negocio
├── configuracion/     # ⚙️ Configuración del sistema
└── api/               # 🔌 Endpoints del servidor
```

## 🔧 Scripts Disponibles

```bash
# Desarrollo
npm run dev              # Servidor de desarrollo
npm run build           # Construir para producción
npm run start           # Servidor de producción
npm run lint            # Linting del código
npm run type-check      # Verificar tipos TypeScript

# Testing
npm run test            # Tests unitarios
npm run test:watch      # Tests en modo watch
npm run test:coverage   # Tests con cobertura
npm run test:e2e        # Tests end-to-end

# Base de datos (opcional)
npm run db:generate     # Generar cliente Prisma
npm run db:push         # Sincronizar esquema
npm run db:migrate      # Ejecutar migraciones
npm run db:studio       # Abrir Prisma Studio
npm run db:seed         # Poblar con datos de ejemplo
```

## 🌟 Características Destacadas

### 🔐 Sistema de Autenticación
- ✅ **Sistema de autenticación robusto** con NextAuth.js
- ✅ Protección completa de todas las rutas sensibles
- ✅ Modal de login automático para usuarios no autenticados
- ✅ Soporte para roles de usuario (Administrador y Vendedor)
- ✅ Credenciales de demo integradas y funcionales

### 🎨 Interfaz de Usuario
- ✅ **Diseño consistente** con tema café/mirador
- ✅ Navegación superior completa con todos los módulos
- ✅ Búsqueda global funcional
- ✅ Centro de notificaciones (3 notificaciones)
- ✅ Avatar de usuario con menú desplegable
- ✅ Responsive design implementado

### 📱 Características Técnicas
- ✅ **Next.js 14.2.32** funcionando correctamente
- ✅ **PWA support** (deshabilitado en desarrollo)
- ✅ **TypeScript** completamente implementado
- ✅ **Tailwind CSS** para estilos
- ✅ **Componentes Radix UI** para interfaz
- ✅ **Lucide React** para iconografía

### 📊 Datos Mock Incluidos
- ✅ **8 productos de café** con precios múltiples
- ✅ **Estadísticas de ventas** históricas
- ✅ **3 notificaciones** activas en el sistema
- ✅ **3 alertas de inventario** (críticas y altas)
- ✅ **5 reportes activos** y 4 programados
- ✅ **Actividad reciente** simulada

## 🚀 Despliegue

### Vercel (Recomendado)
1. Conecta tu repositorio a Vercel
2. Configura las variables de entorno en el dashboard
3. Deploy automático en cada push a main

### Manual
```bash
# Build de producción
npm run build

# Iniciar servidor de producción
npm start
```

## 🚀 Roadmap de Desarrollo

### 🔗 **Integración con Servicios Externos**
- **Base de datos**: Migrar a PostgreSQL para datos persistentes
- **Sistemas contables**: Integración con SIIGO, World Office, Alegra
- **APIs de terceros**: Conectar servicios de facturación y pagos
- **PWA**: Habilitar funcionalidad offline completa

### 📈 **Optimizaciones de Rendimiento**
- **Lazy loading** para componentes pesados
- **Bundle splitting** optimizado
- **Service Workers** para cacheo inteligente
- **Compresión** gzip/brotli en producción

### 🔐 **Mejoras de Seguridad y Monitoreo**
- **Rate limiting** en endpoints críticos
- **Monitoreo de errores** con Sentry
- **Logs estructurados** para auditoría
- **2FA** para usuarios administradores

## 🤝 Contribución

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request



## 📄 Licencia

Este proyecto está bajo la Licencia MIT. Ver el archivo `LICENSE` para más detalles.

## 📞 Soporte

Para soporte técnico o consultas:
- **Issues**: [GitHub Issues](https://github.com/alvaretto/cafe-pwa/issues)
- **Documentación**: Consulta este README para información completa

---

**✨ CRM Tinto del Mirador - Sistema Completo con IA**

La aplicación está completamente operativa con todos los módulos funcionando correctamente, incluyendo **integración completa con Anthropic Claude AI** para asistencia inteligente. El sistema ha sido optimizado y estabilizado para garantizar máxima confiabilidad. Listo para desarrollo adicional o despliegue en producción.


